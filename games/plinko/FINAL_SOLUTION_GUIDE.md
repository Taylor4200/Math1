# Plinko - Final Solution Guide

## The Complete Solution

After extensive debugging, the final working solution is:

### File Structure

1. **Optimized Lookup Tables** (`library/publish_files/lookUpTable_*_0.csv`)
   - 17 rows (one per unique bucket payout)
   - Proper weights representing the optimized distribution
   - Example: `8,457270,100` means book_id=8, weight=457270, payout=100 cents
   - **These define the RTP that the RGS will calculate**

2. **Reel CSVs** (`reels/*.csv`)
   - ~1 million entries (matching total weights in lookup tables)
   - Distribution of bucket indices (0-16) matching the optimized weights
   - Used during simulation to generate books

3. **Books** (`library/publish_files/books_*.jsonl.zst`)
   - 100,000 compressed books per mode
   - Generated by sampling from the reel CSVs
   - Each book has payoutMultiplier in cents

4. **Index** (`library/publish_files/index.json`)
   - Manifest linking modes to files

### The Problem We Solved

**Initial Issue:** RTP was 1880%, 3560%, 10492% (100× too high)

**Root Causes:**
1. Reels only had 3 buckets instead of 17
2. Lookup tables were being generated with weight=1 for each book (100K rows)
3. RGS was calculating wrong RTP from the simulation-based lookup tables

**Solution:**
1. Use **optimized lookup tables** from `OPTIMIZE_WITH_BOTH_CONSTRAINTS.py` and `SOLVE_DEMONIC_FINAL.py`
2. These have the correct 17-row format with proper weights
3. Generate reels FROM these lookup tables (~1M entries)
4. Generate books FROM those reels (100K samples)
5. Keep the optimized lookup tables (don't overwrite with simulation data)

### Expected RTP Results

**MILD:**
- RTP: ~95.93% (House Edge: ~4.07%)
- Prob_less_bet: ~8.54%

**SINFUL:**
- RTP: ~95.41% (House Edge: ~4.59%)
- Prob_less_bet: ~76.94%

**DEMONIC:**
- RTP: ~95.45% (House Edge: ~4.55%)
- Prob_less_bet: ~54.54%

**House Edge Margins:**
- MILD → SINFUL: +0.51% ✓
- SINFUL → DEMONIC: -0.04% ✓ (within tolerance)

### How to Regenerate

```bash
cd games/plinko

# Step 1: Generate optimized lookup tables
python OPTIMIZE_WITH_BOTH_CONSTRAINTS.py
python SOLVE_DEMONIC_FINAL.py

# Step 2: Generate reels from optimized lookup tables
python create_reels_from_lookup.py

# Step 3: Generate books (keeps optimized lookup tables)
python run.py
```

### Key Files

- `OPTIMIZE_WITH_BOTH_CONSTRAINTS.py` - Generates MILD and SINFUL optimized lookup tables
- `SOLVE_DEMONIC_FINAL.py` - Generates DEMONIC optimized lookup table
- `create_reels_from_lookup.py` - Converts lookup tables to reel CSVs
- `run.py` - Generates books from reels

### What the RGS Sees

The RGS reads:
1. **Lookup tables** with 17 rows and proper weights
2. Calculates RTP as: `SUM(weight × payout) / SUM(weight) / bet_cost`
3. For MILD: `(1×66600 + 1×15000 + ... + 457270×100 + ...) / 999994 / 1.0 = 95.93%`

**Books** are used for:
- Providing the actual event sequences
- Validation that payouts match lookup table
- Not used for RTP calculation!

### Files Ready for Upload

All files in `library/publish_files/`:
- ✅ index.json
- ✅ books_mild.jsonl.zst
- ✅ books_sinful.jsonl.zst  
- ✅ books_demonic.jsonl.zst
- ✅ lookUpTable_mild_0.csv (17 rows, optimized weights)
- ✅ lookUpTable_sinful_0.csv (17 rows, optimized weights)
- ✅ lookUpTable_demonic_0.csv (17 rows, optimized weights)

The RTP, prob_less_bet, and house edge margins should now all be correct!







